CREATE OR REPLACE STAGE FILE_EXPORT_STAGE
  URL = 'azure://<storage_account>.blob.core.windows.net/<container>'
  CREDENTIALS = (AZURE_SAS_TOKEN = '<sas_token>');

CREATE OR REPLACE STREAM FILE_EXPORT_TEST_STREAM ON TABLE TEST;

SELECT OBJECT_CONSTRUCT(*) FROM FILE_EXPORT_TEST_STREAM

COPY INTO @FILE_EXPORT_STAGE/test FROM (SELECT OBJECT_CONSTRUCT(*) FROM FILE_EXPORT_TEST_STREAM)

CREATE OR REPLACE TASK FILE_EXPORT_TASK
  WAREHOUSE = my_warehouse
AS
  COPY INTO @FILE_EXPORT_STAGE/TEST_||TO_CHAR(CURRENT_TIMESTAMP())||'_'||SEQ8()
  FROM (SELECT OBJECT_CONSTRUCT(*) FROM FILE_EXPORT_TEST_STREAM)
  FILE_FORMAT = (TYPE = 'JSON', COMPRESSION = 'NONE')
  SINGLE = TRUE
  MAX_FILE_SIZE = 16777216;

SET VS_SQLSTM = 'COPY INTO @FILE_EXPORT_STAGE/' || 'TEST_' || TO_STRING(CURRENT_TIMESTAMP())|| '_'|| SEQ8()
  'FROM (SELECT OBJECT_CONSTRUCT(*) FROM FILE_EXPORT_TEST_STREAM)
  FILE_FORMAT = (TYPE = ''JSON'', COMPRESSION = ''NONE'')
  SINGLE = TRUE
  MAX_FILE_SIZE = 16777216;'
