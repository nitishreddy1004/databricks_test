CREATE OR REPLACE PROCEDURE CREATE_STREAM_AND_TASK(P_DATABASE STRING, P_SCHEMA STRING, P_TABLE STRING)
RETURNS STRING
LANGUAGE SQL
AS
$$
DECLARE
  V_FULL_TABLE_NAME STRING;
  V_STREAM STRING;
  V_TASK STRING;
  V_STAGE STRING;
  VS_CREATE_STREAM_SQL STRING;
  VS_CREATE_TASK_SQL STRING;
BEGIN
  V_FULL_TABLE_NAME := P_DATABASE || '' || P_SCHEMA || '' || P_TABLE;
  V_STREAM := V_FULL_TABLE_NAME || '_STREAM';
  V_TASK := V_FULL_TABLE_NAME || '_TASK';
  V_STAGE := 'FILE_EXPORT_STAGE' ;

  -- Create the stream
  VS_CREATE_STREAM_SQL := 'CREATE OR REPLACE STREAM ' || V_STREAM || ' ON TABLE ' || P_DATABASE || '.' || P_SCHEMA || '.' || P_TABLE || ';';
  EXECUTE IMMEDIATE VS_CREATE_STREAM_SQL;

  -- Create the task
  VS_CREATE_TASK_SQL := '
  CREATE OR REPLACE TASK ' || V_TASK || '
  WAREHOUSE = ''COMPUTE_XSMALL''
  SCHEDULE = ''1 MINUTE''
  WHEN SYSTEM$STREAM_HAS_DATA(''' || V_STREAM || ''')
  AS
  BEGIN
  EXECUTE IMMEDIATE (''COPY INTO @' || V_STAGE || '/' || V_FULL_TABLE_NAME || '_''' || ' || TO_CHAR(CURRENT_TIMESTAMP(), 'YYYYMMDD_HH24:MI:SS') || ''' || '.json FROM (SELECT OBJECT_CONSTRUCT(''''ROW_DATA'''',OBJECT_CONSTRUCT(*),''''SOURCE'''',''''' || V_FULL_TABLE_NAME || ''''') AS SOURCE FROM ' || V_STREAM || ')' ||  ' FILE_FORMAT = (TYPE = ''''JSON'''', COMPRESSION = ''''NONE'''')
  SINGLE = TRUE
  MAX_FILE_SIZE = 16777216;'' );

  END;';

  EXECUTE IMMEDIATE VS_CREATE_TASK_SQL;

 -- RETURN 'Stream and Task created successfully';
 RETURN VS_CREATE_TASK_SQL;
END;
$$;

CALL CREATE_STREAM_AND_TASK('DATAFORCE','FOG','TEST');
